<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainPageLayout.html}">
<title layout:fragment="title">장바구니</title>
<body>
<!--나중에 layout 으로 싹 갈아야함-->
<main layout:fragment="content" class="m-3">
    <div class="d-flex flex-md-row flex-column mb-4 justify-content-evenly cartProduct"></div>
    <ul class="pagination cartPagination"></ul>
    <button type="button" class="btn btn-primary makeReservationBtn">예약</button>
<!--    <button type="button" class="btn btn-secondary" onclick="addCart(1)">1 장바구니 추가 (임시)</button>-->
<!--    <button type="button" class="btn btn-secondary" onclick="addCart(2)">2 장바구니 추가 (임시)</button>-->
<!--    <button type="button" class="btn btn-secondary" onclick="addCart(3)">3 장바구니 추가 (임시)</button>-->
<!--    <button type="button" class="btn btn-secondary" onclick="makeReservationImmediately(1)">1 즉시 예약 (임시)</button>-->
</main>

<div layout:fragment="javascript">
    <script src="/script/cart/cart.js"></script>
    <script>
        const cartProduct = document.querySelector(".cartProduct")
        const cartPagination = document.querySelector(".cartPagination")

        function printCart(page) {
            getCart({page})
                .then(data => {
                        printCartProduct(data.dtoList)
                        printCartPagination(data)
                    }
                ).catch(e => {
                    console.error(e)
                }
            )
        }

        function printCartProduct(dtoList) {
            let str = ""
            if (dtoList && dtoList.length > 0) {
                for (const dto of dtoList) {
                    str += `
                        <div class="card" style="width: 18rem; position: relative;">
                            <button type="button" class="btn-close position-absolute top-0 end-0"
                                    data-productNo="${dto.productNo}" aria-label="Close"></button>
                            <img class="card-img-top ${dto.imagePath}" src="" alt="Card image cap">
                                <div class="card-body">
                                    <h5 class="card-title">${dto.name}</h5>
                                    <p class="card-text">${dto.description}</p>
                                </div>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">${dto.location.city}/${dto.location.country}</li>
                                    <li class="list-group-item">${dto.startDate}~${dto.endDate}</li>
                                    <li class="list-group-item">${dto.price}원</li>
                                </ul>
                        </div>
                    `
                }
            }
            cartProduct.innerHTML = str
            for (const dto of dtoList) {
                setImagePath(dto.imagePath)
            }
        }

        function printCartPagination(data) {
            let pageStr = ''
            if (data.prev) {
                pageStr += `<li class="page-item"><a class="page-link"
            data-page="${data.start - 1}">이전</a></li>
             `
            }
            for (let i = data.start; i <= data.end; i++) {
                pageStr += `
            <li class="${data.page == i}?'page-item active':'page-item'">
                                    <a class="page-link"
                                       data-page="${i}">${i}</a>
                                </li>
            `
            }
            if (data.next) {
                pageStr += `<li class="page-item"><a class="page-link"
            data-page="${data.end + 1}">다음</a></li>
             `
            }
            cartPagination.innerHTML = pageStr
        }

        let page = 1
        cartPagination.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            const target = e.target

            if (!target || target.tagName != 'A') {
                return
            }
            const pageNum = target.getAttribute("data-page")
            page = pageNum
            printCart(page)

        }, false)

        printCart(page)

        document.querySelector(".makeReservationBtn").addEventListener("click", function (e) {
            makeReservation().then(data => {
                if (data.reservationNoSize == 0) alert("예약 가능한 여행이 없습니다.")
                else {
                    alert(data.reservationNoSize + "개의 예약 완료")
                    window.location.href = "/member/reservation"
                }

            }).catch(e => {
                    console.error(e)
                }
            )
        })
        document.querySelector(".cartProduct").addEventListener("click", async function (e) {
            e.stopPropagation()
            e.preventDefault()
            const target = e.target
            if (target.tagName != 'BUTTON') return
            const productNo = target.getAttribute("data-productNo")
            await delCart(productNo).then(data => {
                if (data) alert("삭제되었습니다.")
                else alert("삭제에 실패했습니다.")
            }).catch(e => {
                console.error(e)
            })
            printCart(page)
        })

        function setImagePath(imagePath) {
            const imagePaths = document.getElementsByClassName(imagePath)
            for (let image of imagePaths) {
            image.src = '/productImage/' + imagePath
            }
        }
    </script>
</div>
</body>
</html>